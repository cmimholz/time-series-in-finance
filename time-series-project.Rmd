---
title: "TIME SERIES ANALYSIS"
author: "Victor Anton, Imholz Chris"
date: "19.12.2024"
output:
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: console
  markdown:
    wrap: 72
---

CHECK EXAMPLES



Structure
## 1. Identification phase: Identification of the appropriate model (descriptive analysis!)


### Descriptive analysis
Objective: Understand how the time series in question are characterized. Results are used as a basis for adequately modelling the subject in question and hence as a basis for inference analysis and forecasting.

− Visualization of the data using basic graphical methods
− Data preparation and transformation
− Decomposition of time series
− Description of the available data using statistical analysis (central moments of the distribution etc.)
− Multivariate analysis: How do different variables relate to each other?
− Analysis of time series characteristics using statistical test methods

## 2. Estimation phase: Model specification and estimation of model parameters

## 3. Diagnostic phase: Evaluation of the quality and validity of the model

## 4. Operational phase: Use of the estimated model for inference analysis or forecasting


```{r libraries, warning=FALSE, message=FALSE}

# Load libraries
library(tidyquant)
library(quantmod)
library(ggplot2)
library(dplyr)
```

```{r titles_of_code, echo = TRUE, fig.width=10}




```

## Bedeutungen der Spaltenüberschriften

Die folgenden Spaltenüberschriften erscheinen in den heruntergeladenen Daten. `[SYMBOL]` steht für das jeweilige Börsensymbol der Aktie.

| **Spalte**         | **Bedeutung**                                                                                 |
|---------------------|-----------------------------------------------------------------------------------------------|
| `[SYMBOL].Open`    | Eröffnungskurs der Aktie (Price at the market open) an einem bestimmten Handelstag.           |
| `[SYMBOL].High`    | Höchster Kurs der Aktie während des Handelstages (Highest intraday price).                    |
| `[SYMBOL].Low`     | Niedrigster Kurs der Aktie während des Handelstages (Lowest intraday price).                  |
| `[SYMBOL].Close`   | Schlusskurs der Aktie am Ende des Handelstages (Price at the market close).                   |
| `[SYMBOL].Volume`  | Anzahl der gehandelten Aktien während des Handelstages (Trading volume).                      |
| `[SYMBOL].Adjusted`| Angepasster Schlusskurs der Aktie, der Dividenden, Splits und andere Anpassungen berücksichtigt (Adjusted close). |


```{r share_download, echo = TRUE, fig.width=10}


smi_symbols <- c(
  "ABBN.SW", "ADEN.SW", "ALC.SW", "CFR.SW", "GEBN.SW", "GIVN.SW",
  "HOLN.SW", "BAER.SW", "KNIN.SW", "LOGN.SW", "LONN.SW", "NESN.SW",
  "NOVN.SW", "PGHN.SW", "ROG.SW", "SIKA.SW", "SOON.SW", "SLHN.SW",
  "SREN.SW", "SCMN.SW", "UHR.SW", "UBSG.SW", "ZURN.SW"
)


# Abrufen der aktuellen S&P 500-Unternehmen
 sp500 <- tq_index("SP500")
 head(sp500)

# Function to download data for each stock
download_data <- function(symbols, start_date = "2022-01-01",end_date = Sys.Date()) {
  stock_data <- list()
  for (symbol in symbols) {
    tryCatch({
      stock_data[[symbol]] <- getSymbols(symbol, src = "yahoo", 
                                         from = start_date, 
                                         to = end_date, 
                                         auto.assign = FALSE)
      cat("Downloaded data for:", symbol, "\n")
    }, error = function(e) {
      cat("Error downloading data for:", symbol, "\n")
    })
  }
  return(stock_data)
}

# Download data
smi_data <- download_data(smi_symbols)
#s_p_data <- download_data(sp500$symbol)

# Save the data to RDS for future use
saveRDS(smi_data, file = "smi_stock_data.rds")
#saveRDS(s_p_data, file = "s_p_stock_data.rds")

# Example: Accessing data for a specific stock (e.g., Nestlé)
head(smi_data[["NESN.SW"]],10)
```

smi_data

```{r chart visual, echo = TRUE, fig.width=10}

#function visualises char
plot_stock <- function(stock_data, symbol) {
  if (!is.null(stock_data[[symbol]])) {
    stock <- stock_data[[symbol]]
    # Ensure the adjusted price column is available
    column_name <- paste0(symbol, ".Adjusted")
    if (column_name %in% colnames(stock)) {
      plot(stock[, column_name], 
           main = paste("Stock Prices for", symbol), 
           xlab = "Date", 
           ylab = "Adjusted Price", 
           col = "blue", 
           type = "l")
    } else {
      cat("Adjusted price data not available for:", symbol, "\n")
    }
  } else {
    cat("No data available for:", symbol, "\n")
  }
}


# Example: Plot Nestlé stock data
plot_stock(smi_data, "NESN.SW")

# Example: Plot NVIDIA stock data
# plot_stock(s_p_data, "AAPL")
```

```{r chart Change , echo = TRUE, fig.width=10}
# Funktion zur Berechnung der % Differenz für eine Aktie
calc_percent_diff <- function(stock_data, symbol) {
  if (!is.null(stock_data[[symbol]])) {
    # Zugriff auf die Schlusskursspalte
    close_col <- paste0(symbol, ".Adjusted")
    if (close_col %in% colnames(stock_data[[symbol]])) {
      # Berechnung der prozentualen Differenz
      close_prices <- stock_data[[symbol]][, close_col]
      percent_diff <- (close_prices / lag(close_prices) - 1) * 100
      
      # Neuer Spaltenname mit Symbol und ".Percent_Diff"
      percent_diff_col <- paste0(symbol, ".Percent_Diff")
      
      # Sicherstellen, dass der Datensatz als Dataframe behandelt wird
      stock_data[[symbol]] <- as.data.frame(stock_data[[symbol]])
      
      
      
      # Spalte mit Differenzen hinzufügen
      stock_data[[symbol]][, percent_diff_col] <- percent_diff
      
      
      
      return(stock_data[[symbol]])
    } else {
      cat("Close column not found for:", symbol, "\n")
      return(NULL)
    }
  } else {
    cat("No data available for:", symbol, "\n")
    return(NULL)
  }
}

# Apply the function to all stocks while maintaining structure
calc_all_percent_diff <- function(stock_data, symbols) {
  modified_stock_data <- stock_data  # Copy the original list structure
  for (symbol in symbols) {
    modified_stock_data[[symbol]] <- calc_percent_diff(stock_data, symbol)
  }
  return(modified_stock_data)
}

# Beispiel: Berechnung der % Differenz für SMI
smi_percent_diff <- calc_all_percent_diff(smi_data, smi_symbols)

# Beispiel: Zugriff auf die berechnete Differenz für UBSG.SW
head(smi_percent_diff[["UBSG.SW"]])

smi_percent_diff

```

Die Strategie erfordert:

1. Identifikation von Ereignissen mit ≥ 5 % Kursänderung.
2. Kauf der Aktie 3 Tage nach dem Ereignis.
3. Halten der Aktie für 30 Tage.
4. Berechnung der Renditen.


```{r strategy_identify, echo = TRUE, fig.width=10}
#1. Identifikation von Ereignissen mit ≥ 5 % Kursänderung.
identify_events <- function(stock_data, symbol, threshold) {
  if (!is.null(stock_data[[symbol]])) {
    percent_diff_col <- paste0(symbol, ".Percent_Diff")
    if (percent_diff_col %in% colnames(stock_data[[symbol]])) {
      stock_data[[symbol]] <- as.data.frame(stock_data[[symbol]])
      stock_data[[symbol]]$Event <- stock_data[[symbol]][, percent_diff_col] < threshold
      return(stock_data[[symbol]])
    } else {
      cat("Percent diff column not found for:", symbol, "\n")
      return(NULL)
    }
  } else {
    cat("No data available for:", symbol, "\n")
    return(NULL)
  }
}

# Initialisiere eine leere Liste, um Ergebnisse zu speichern
smi_with_events <- list()

# For-Loop, um Ereignisse zu identifizieren
for (i in seq_along(smi_percent_diff)) {
  symbol <- smi_symbols[i]  # Das aktuelle Symbol
  smi_with_events[[symbol]] <- identify_events(stock_data = smi_percent_diff, 
                                               symbol = symbol, 
                                               threshold = -5.0)
}

smi_with_events



```


2. Kauf der Aktie 3 Tage nach dem Ereignis.
```{r strategy_identify, echo = TRUE, fig.width=10}
#2. Kauf der Aktie 3 Tage nach dem Ereignis.

# Funktion zum Hinzufügen des Kaufdatums
add_buy_dates <- function(stock_data, symbol) {
  if (!is.null(stock_data[[symbol]])) {
    stock_data[[symbol]] <- as.data.frame(stock_data[[symbol]])
    # Hinzufügen der Spalte "Buy_Date", 3 Tage nach einem Ereignis
    stock_data[[symbol]]$Buy_Date <- ifelse(
      stock_data[[symbol]]$Event,  # Wenn ein Ereignis identifiziert wurde
      index(stock_data[[symbol]]) + 3,  # Kaufdatum = Ereignisdatum + 3 Tage
      NA  # Sonst NA
    )
    return(stock_data[[symbol]])
  } else {
    cat("No data available for:", symbol, "\n")
    return(NULL)
  }
}

# For-Loop, um Kaufdaten hinzuzufügen
smi_with_buy_dates <- list()

for (i in seq_along(smi_with_events)) {
  symbol <- smi_symbols[i]  # Das aktuelle Symbol
  smi_with_buy_dates[[symbol]] <- add_buy_dates(stock_data = smi_with_events, symbol = symbol)
}


smi_with_buy_dates
```

```{r strategy_identify, echo = TRUE, fig.width=10}
# Funktion zur Berechnung der Renditen
calculate_returns <- function(stock_data, symbol) {
  if (!is.null(stock_data[[symbol]])) {
    stock_data[[symbol]] <- as.data.frame(stock_data[[symbol]])
    adjusted_col <- paste0(symbol, ".Adjusted")  # Angepasster Schlusskurs

    if (adjusted_col %in% colnames(stock_data[[symbol]])) {
      # Rendite berechnen
      stock_data[[symbol]]$Return <- ifelse(
        !is.na(stock_data[[symbol]]$Buy_Date),  # Wenn ein Kaufdatum existiert
        {
          # Kaufpreis (Schlusskurs am Buy_Date)
          buy_price <- lag(stock_data[[symbol]][, adjusted_col], 3)
          # Verkaufspreis (Schlusskurs nach 30 Tagen)
          sell_price <- lead(stock_data[[symbol]][, adjusted_col], 30)
          # Rendite berechnen
          (sell_price - buy_price) / buy_price
        },
        NA  # Keine Rendite, wenn kein Kaufdatum vorhanden ist
      )
      return(stock_data[[symbol]])
    } else {
      cat("Adjusted price column not found for:", symbol, "\n")
      return(NULL)
    }
  } else {
    cat("No data available for:", symbol, "\n")
    return(NULL)
  }
}

# For-Loop, um Renditen für jedes Symbol zu berechnen
smi_with_returns <- list()

for (i in seq_along(smi_with_buy_dates)) {
  symbol <- smi_symbols[i]  # Das aktuelle Symbol
  smi_with_returns[[symbol]] <- calculate_returns(stock_data = smi_with_buy_dates, symbol = symbol)
}
```

## GenAI Usage